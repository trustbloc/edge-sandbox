<! ––
Copyright SecureKey Technologies Inc. All Rights Reserved.

SPDX-License-Identifier: Apache-2.0
––>

<html>

<head>
    <title>Issuer</title>
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/css/materialize.min.css">
    <script src="https://unpkg.com/credential-handler-polyfill@2.1.1/dist/credential-handler-polyfill.min.js"></script>
    <script src="https://unpkg.com/web-credential-handler@1.0.1/dist/web-credential-handler.min.js"></script>
</head>

<body>
<div class="section"></div>
<main>
    <div class="container">
        <div class="row">
            <label for="vcsProfile">Profile:</label>
            <select id="vcsProfile" style="display:block">
                <option value="vc-issuer-1">vc-issuer-1</option>
                <option value="vc-issuer-2">vc-issuer-2</option>
            </select>
        </div>
        <div class="row">
            <div class="btn white darken-6 col s4">
                <a href="#" onclick="redirectURL('StudentCard');return false;" style="text-transform:none">
                    Issue Student Card
                </a>
            </div>
        </div>
        <div class="row">
            <div class="btn white darken-6 col s4">
                <a onclick="redirectURL('TravelCard');return false;" style="text-transform:none">
                    Issue Travel Card
                </a>
            </div>
        </div>
        <div class="row">
        <div class="btn white darken-6 col s4">
            <a href="reader/qrReader.html" style="text-transform:none">
                Scan Barcode
            </a>
        </div>
        </div>

        <div class="row">
            <button id='revokeVCBtn'>Revoke VC</button>
            <form method="post" id="vcForm" action="/revoke">
                <input type="hidden" name="vcDataInput" id="vcDataInput">
            </form>
        </div>
    </div>
</main>

</body>

<script>
    installHandler()
        .catch(e => console.error('Error in installHandler:', e));

    async function installHandler() {
        console.log('Loading polyfill...');
        try {
            await credentialHandlerPolyfill.loadOnce();
        } catch(e) {
            console.error('Error in loadOnce:', e);
        }
    }

    function ready(fn) {
        if (document.readyState !== 'loading'){
            fn();
        } else {
            document.addEventListener('DOMContentLoaded', fn);
        }
    }

    async function onClickGet() {
        const credentialQuery = JSON.parse('{"web": {"VerifiablePresentation": {}}}');
        const result = await navigator.credentials.get(credentialQuery);
        if(!result) {
            alert("null result");
            return;
        }
        document.getElementById('vcDataInput').value=result.data
        document.getElementById('vcForm').submit()
    }

    ready(() => {
        document.getElementById('revokeVCBtn').addEventListener('click', onClickGet);
    })

    function redirectURL(scope) {
        const vcsProfile=document.getElementById('vcsProfile').value
        window.location= "/login?scope="+scope+"&vcsProfile="+vcsProfile;
    }

</script>

</html>
